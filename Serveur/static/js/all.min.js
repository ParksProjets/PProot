// PProot, created by Guillaume Gonnet
function getCaretPosIn(e){var t=window.getSelection().getRangeAt(0),n=t.cloneRange();n.selectNodeContents(e);n.setEnd(t.endContainer,t.endOffset);return n.toString().length}function setCaretPosIn(e,t){setSelectionRange(e,t,t)}function getTextNodesIn(e){if(e.nodeType==3)return[e];var t=e.childNodes,n=[];for(var r=0,i=t.length;r<i;++r)n.push.apply(n,getTextNodesIn(t[r]));return n}function setSelectionRange(e,t,n){var r=document.createRange();r.selectNodeContents(e);var i=getTextNodesIn(e);var s=false;var o=0,u;for(var a=0,f;f=i[a++];){u=o+f.length;if(!s&&t>=o&&t<=u){r.setStart(f,t-o);s=true}if(s&&n<=u){r.setEnd(f,n-o);break}o=u}var l=window.getSelection();l.removeAllRanges();l.addRange(r)}function updateNbrPc(){$nbrPc.text(Object.keys(App.list).length)}function onClickBtnActive(e){App.post("activePC",{ip:e.data.ip+":"+e.data.port})}function onClickBtnUnActive(e){App.post("unactivePC",{ip:e.data.ip+":"+e.data.port})}function onClickBtnShutdown(e){App.post("cmd",{cmd:"shutdown",ip:e.data.ip+":"+e.data.port});App.update()}function filtrePC(e){if(!e)e=$filtre.val().trim().toLowerCase();$tablePc.find("tr").each(function(){var t=$(this);if(t.find("td:eq(2)").text().toLowerCase().search(e)!=-1)t.show();else t.hide()})}function speFadeOut(){$cacheSpe.fadeOut();$speAddPanel.fadeOut();$spePanel.fadeOut();if(currentSpe)App.cmd("setSpeOpt",{name:currentSpe,users:$spePanelUsers.pedit(),seq:$spePanelSelect.val()});currentSpe=null}function onSpeClick(e){e.stopPropagation();var t=currentSpe=$(this).parent().attr("data-name");$spePanelH3.text(t);$spePanelUsers.pedit(specialites[t].users.join(" "));$spePanelSelect.val(specialites[t].seq||"empty");$cacheSpe.fadeIn();$spePanel.fadeIn()}function switchSpe(e){App.cmd("activeSpe",{name:$(this).attr("data-name"),value:!$(this).hasClass("active")})}function seqFadeOut(){$cacheSeq.fadeOut();$seqAddPanel.fadeOut();$seqPanel.fadeOut();if(currentSeq)App.cmd("setSeqCmds",{name:currentSeq,cmds:$seqPanelText.text()});currentSeq=null}function onSeqClick(){var e=currentSeq=$(this).attr("data-name");$seqPanelH3.text(e);setSeqPanelTxt(sequences[e].cmds.join("\n"));$cacheSeq.fadeIn();$seqPanel.fadeIn()}function setSeqPanelTxt(e){e=e.replace(/"([^"\n]+)(["\n]?)/g,'<span style="color:#7977B0">"$1$2</span>');for(var t=0;t<seqCmdWords.length;t++)e=e.replace(new RegExp("(\\b"+seqCmdWords[t]+"\\b)","g"),'<span style="color:#F06666">$1</span>');$seqPanelText.html(e)}(function(e){function t(){var t=e(this);var n=t.text().split(/[\s]+/);if(t.is(":focus"))var r=getCaretPosIn(this);else var r=false;t.empty();n.forEach(function(r,i){if(!r.trim().length){if(i==n.length-1&&t.text().length)t.append("&nbsp;");return}if(t.text().length)t.append("&nbsp;");t.append(e("<span></span>").text(r))});if(r!==false)setCaretPosIn(this,Math.min(r,t.text().length))}e.fn.pedit=function(n,r){if(typeof n=="undefined"){return this.text().trim().split(/[\s]+/)}if(typeof n=="string"){this.text(n);this.trigger("input");if(r)this.trigger("blur");return}n=e.extend({},e.fn.pedit.defaults,n);this.bind("propertychange keyup input paste",t);return this.each(function(){function s(){if(i==t.text().trim())return;i=t.text().trim();t.trigger({type:"change",value:i,elements:i.split(/[\s]+/)})}var t=e(this),r=null,i=t.text();t.unbind("change");t.focus(function(){if(n.timer&&!r)r=setInterval(s,n.interval)});t.blur(function(){clearInterval(r);r=null;s()})})};e.fn.pedit.defaults={timer:true,interval:1e3}})(jQuery);var EventDispatcher=function(){};EventDispatcher.prototype={constructor:EventDispatcher,apply:function(e){e.addEventListener=EventDispatcher.prototype.addEventListener;e.hasEventListener=EventDispatcher.prototype.hasEventListener;e.removeEventListener=EventDispatcher.prototype.removeEventListener;e.dispatchEvent=EventDispatcher.prototype.dispatchEvent},addEventListener:function(e,t){if(this._listeners===undefined)this._listeners={};var n=this._listeners;if(n[e]===undefined){n[e]=[]}if(n[e].indexOf(t)===-1){n[e].push(t)}},hasEventListener:function(e,t){if(this._listeners===undefined)return false;var n=this._listeners;if(n[e]!==undefined&&n[e].indexOf(t)!==-1){return true}return false},removeEventListener:function(e,t){if(this._listeners===undefined)return;var n=this._listeners;var r=n[e];if(r!==undefined){var i=r.indexOf(t);if(i!==-1){r.splice(i,1)}}},dispatchEvent:function(e){if(this._listeners===undefined)return;var t=this._listeners;var n=t[e.type];if(n!==undefined){e.target=this;var r=[];var i=n.length;for(var s=0;s<i;s++){r[s]=n[s]}for(var s=0;s<i;s++){r[s].call(this,e)}}}};String.prototype.splice=function(e,t,n){return this.slice(0,e)+n+this.slice(e+Math.abs(t))};var App={};EventDispatcher.prototype.apply(App);App.password="";App.post=function(e,t,n,r){function o(e){if(r)r(e)}var i="pwd="+App.password;t=t||{};for(var s in t)i+="&"+s+"="+t[s];$.ajax({url:e,method:"post",data:i,success:function(e){if(e.error)return o(e.error);if(e.success)App.dispatchEvent({type:"success-"+e.success});if(e.set)App.dispatchEvent({type:"set-"+e.set,message:{ip:e.ip||"all",value:e.value}});if(n)n(e)},error:function(e){o("connect")}})};App.cmd=function(e,t,n,r){t.cmd=e;App.post("cmd",t,n,r)};App.list={};App.update=function(e,t){App.dispatchEvent({type:"start-updateList"});App.post("/getList",null,function(t){App.checkList(t.list);delete t.list;for(var n in t)App.dispatchEvent({type:"set-"+n,message:{value:t[n]}});App.dispatchEvent({type:"stop-updateList"});if(e)e(t)},function(e){App.dispatchEvent({type:"stop-updateList"});if(t)t(e)})};App.checkList=function(e){for(var t in App.list){if(e[t])continue;var n=App.list[t];delete App.list[t];App.dispatchEvent({type:"delete-pc",message:n})}for(var t in e){var r=e[t];if(App.list[t]){var i=App.list[t];for(var s in r){if(r[s]==i[s])continue;i[s]=r[s];App.dispatchEvent({type:"set-"+s,message:{ip:t,value:r[s]}})}continue}var r=App.list[t]=e[t];App.dispatchEvent({type:"new-pc",message:r});for(var s in r)App.dispatchEvent({type:"set-"+s,message:{ip:t,value:r[s]}})}};App.timer=null;App.interval=1e4;App.startTimer=function(){App.timer=setInterval(App.update,App.interval)};App.stopTimer=function(){clearInterval(App.timer);App.timer=null};var $mainPage=$("#page-main"),$nbrPc=$("#nbrConnectedPc b");$("#page-password form").submit(function(e){e.preventDefault();var t=$(this);App.password=$(this).find("input").val();App.update(function(){var e=new TimelineMax({pause:true,onComplete:function(){console.log(45);$mainPage.css("transform","")}});e.to(t.find("input"),1,{x:-200,opacity:0}).to(t.find("button"),1,{x:200,opacity:0},0).fromTo($mainPage,.5,{y:200,display:"block",opacity:0},{y:0,opacity:1},"-=0.7");e.play();App.startTimer()})});App.addEventListener("new-pc",updateNbrPc);App.addEventListener("delete-pc",updateNbrPc);var $views=$(".views"),$cachePanel=$("#cachePanel");var Affichages={};Affichages.current="none";Affichages.set=function(e,t){$views.filter('[data-name="'+Affichages.current+'"]').removeClass("active");if(!e||e=="none"){Affichages.current=null;return}$views.filter('[data-name="'+e+'"]').addClass("active");Affichages.current=e};$views.click(function(){var e=$(this).attr("data-name");if(e==Affichages.current)e="none";Affichages.set(e);App.post("setAffichage",{aff:e})});App.addEventListener("set-affichage",function(e){Affichages.set(e.message.value)});$views.find(".edit").click(function(e){e.stopPropagation();var t=$(this).parent().attr("data-name"),n=$('.panel[data-name="'+t+'"]');$cachePanel.fadeIn();n.fadeIn()});$cachePanel.click(function(){var e=$(".panel:visible");e.fadeOut();$cachePanel.fadeOut()});var $tablePc=$("#pc-list tbody"),$filtre=$("#pcFiltre");App.addEventListener("new-pc",function(e){console.log(e.message);var t=$('<tr data-ip="'+e.message.ip+":"+e.message.port+'"></tr>');t.append("<td>"+e.message.ip+"</td>");t.append("<td>"+e.message.port+"</td>");t.append('<td class="nameUser">'+e.message.nameUser+"</td>");var n=$('<button class="btn btn-Ac">Activer</button>'),r=$('<button class="btn btn-red btn-UnAc">DÃ©sactiver</button>'),i=$('<button class="btn">Shutdown</button>'),s=$("<td></td>");n.click(e.message,onClickBtnActive);r.click(e.message,onClickBtnUnActive).hide();i.click(e.message,onClickBtnShutdown);s.append([n,r,i]);t.append(s);$tablePc.append(t);filtrePC()});App.addEventListener("delete-pc",function(e){$elem=$tablePc.find('tr[data-ip="'+e.message.ip+":"+e.message.port+'"]');$elem.remove()});App.addEventListener("set-nameUser",function(e){var t=$tablePc.find('tr[data-ip="'+e.message.ip+'"]');t.find(".nameUser").text(e.message.value)});App.addEventListener("set-active",function(e){var t=$tablePc.find('tr[data-ip="'+e.message.ip+'"]');var n=t.find(".btn-Ac").hide(),r=t.find(".btn-UnAc").hide();if(e.message.value)r.show();else n.show()});$filtre.bind("propertychange keyup input paste",function(){filtrePC()});var $inputUnlock=$("#input-userUnlokck"),$inputSpe=$("#input-userSpe"),$btnReloadTime=$("#input-reloadTime");$(".p-edit").pedit({});$btnReloadTime.change(function(){if(!$(this).val())return;App.stopTimer();App.interval=parseInt($(this).val())*1e3;App.startTimer()});$inputUnlock.change(function(e){App.cmd("setUnlockedUsers",{users:e.elements.join(",")})});App.addEventListener("set-unlockedUsers",function(e){if(!$inputUnlock.is(":focus"))$inputUnlock.pedit(e.message.value.join(" "))});var $speContainer=$("#spe"),$cacheSpe=$("#cacheSpe"),$speAddPanel=$("#speAddPanel"),$spePanel=$("#spePanel"),$spePanelH3=$spePanel.find("h3 span"),$spePanelUsers=$spePanel.find(".p-edit"),$spePanelSelect=$spePanel.find("select");var specialites={};App.addEventListener("set-Spe",function(e){var t=e.message.value;var n=$speContainer.children(),r={};n.each(function(e,t){var n=$(t);if(n.attr("data-name"))r[n.attr("data-name")]=n});for(var i=0;i<t.length;i++){var s=t[i];if(!specialites[s.name])specialites[s.name]={name:s.name,active:false,users:[],seq:null};specialites[s.name].active=s.active;specialites[s.name].users=s.users;specialites[s.name].seq=s.sequence;if(r[s.name]){if(s.active)r[s.name].addClass("active");else r[s.name].removeClass("active");delete r[s.name];continue}var o=$('<i class="edit">&#xe600;</i>'),u=$("<p>"+s.name+"</p>"),a=$('<div data-name="'+s.name+'"></div>');o.click(onSpeClick);a.click(switchSpe);$speContainer.prepend(a.append([o,u]))}for(var i in r){r[i].remove();delete specialites[i]}});var currentSpe=null;$cacheSpe.click(speFadeOut);$("#addSpeBtn").click(function(){$cacheSpe.fadeIn();$speAddPanel.fadeIn()});$speAddPanel.find("button").click(function(){App.cmd("addSpe",{name:$speAddPanel.find("input").val()});speFadeOut()});$spePanel.find(".delete").click(function(){App.cmd("deleteSpe",{name:currentSpe});currentSpe=null;speFadeOut()});var $seqContainer=$("#sequences"),$seqAddPanel=$("#seqAddPanel"),$seqPanel=$("#seqPanel"),$seqPanelH3=$seqPanel.find("h3 span"),$seqPanelText=$seqPanel.find("pre"),$cacheSeq=$("#cacheSeq");var sequences={};App.addEventListener("set-Sequences",function(e){var t=e.message.value,n=[];var r=$seqContainer.children(),i={};r.each(function(e,t){var n=$(t);if(n.attr("data-name"))i[n.attr("data-name")]=n});for(var s=0;s<t.length;s++){var o=t[s];n.push('<option value="'+o.name+'">'+o.name+"</option>");if(!sequences[o.name])sequences[o.name]={name:o.name,cmds:[]};sequences[o.name].cmds=o.cmds;if(i[o.name]){delete i[o.name];continue}$div=$('<div data-name="'+o.name+'">'+o.name+"</div>");$div.click(onSeqClick);$seqContainer.prepend($div)}for(var s in i){i[s].remove();delete sequences[s]}var u=$(".selectSeq"),a=$(n.join());u.each(function(){var e=$(this),t=e.val();if(!e.is(":focus")){e.empty().append(a.clone());if(e.hasClass("firstEmpty"))e.prepend('<option value="empty"></option>');if(t)e.val(t)}})});var currentSeq=null;$cacheSeq.click(seqFadeOut);$("#addSeqBtn").click(function(){$cacheSeq.fadeIn();$seqAddPanel.fadeIn()});$seqAddPanel.find("button").click(function(){App.cmd("addSequence",{name:$seqAddPanel.find("input").val()});seqFadeOut()});$seqPanel.find(".delete").click(function(){App.cmd("deleteSequence",{name:currentSeq});currentSeq=null;seqFadeOut()});$seqPanelText.bind("input",function(e){var t=$(this).text();var n=getCaretPosIn(this);setSeqPanelTxt(t);setCaretPosIn(this,n)}).keydown(function(e){if(e.keyCode==13){var t=getCaretPosIn(this);$seqPanelText.html($(this).text().splice(t,0,"\n"));setCaretPosIn(this,t+1)}});var $btnAAOff=$("#btn-activeOnAll"),$btnAAOn=$("#btn-unactiveOnAll");$btnAAOff.click(function(){App.post("activePC",{ip:"all"});App.update()});$btnAAOn.click(function(){App.post("unactivePC",{ip:"all"});App.update()});App.addEventListener("set-activeAll",function(e){$btnAAOff.hide();$btnAAOn.hide();if(e.message.value)$btnAAOn.css("display","block");else $btnAAOff.css("display","block")});var $btnSeqOff=$("#btn-seqOff"),$btnSeqOn=$("#btn-seqOn"),$selectSeq=$("#select-seq");$btnSeqOn.click(function(){App.cmd("seqOn",{value:true,seq:$selectSeq.val()})});$btnSeqOff.click(function(){App.cmd("seqOn",{value:false})});App.addEventListener("set-seqOn",function(e){$btnSeqOn.hide();$btnSeqOff.hide();if(e.message.value)$btnSeqOff.css("display","block");else $btnSeqOn.css("display","block")})